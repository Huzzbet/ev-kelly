<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SharpEdge Predictor</title>
<style>
  :root{--bg:#0b0e13;--panel:#171a21;--muted:#a7b0c0;--text:#e8ecf4;--brand:#4da3ff;--ok:#2ecc71;--bad:#e74c3c;}
  html,body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0}
  header{padding:28px 16px 8px;text-align:center}
  h1{margin:0;font-size:32px;letter-spacing:.4px}
  .tag{color:var(--muted);margin-top:6px}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .card{background:var(--panel);border:1px solid #232838;border-radius:14px;padding:16px;margin:14px 0}
  label{display:block;margin:8px 0 6px;color:var(--muted)}
  select,input,button{width:100%;background:#0f1320;border:1px solid #273049;color:var(--text);padding:12px;border-radius:10px;font-size:16px;outline:none}
  input[type="range"]{padding:0}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 260px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .nums{font-variant-numeric:tabular-nums}
  .muted{color:var(--muted)}
  .small{font-size:13px}
  .btn{cursor:pointer;background:linear-gradient(180deg,#2b67ff,#1a49c7);border:none}
  .footer{color:#70819f;font-size:12px;margin-top:24px}

  /* W/L chips */
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{display:inline-block;padding:4px 10px;border-radius:8px;font-size:14px;color:#fff}
  .chip.w{background:var(--ok)}
  .chip.l{background:var(--bad)}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #2a334a;margin-right:6px;margin-top:6px}
  .pill.ok{border-color:#1f5f44;color:var(--ok)}
  .pill.bad{border-color:#6b2c2c;color:var(--bad)}

  /* Visual form input with chips inside */
  .form-box{background:#0f1320;border:1px solid #273049;border-radius:10px;padding:8px 8px 6px;display:flex;flex-wrap:wrap;gap:6px;align-items:center}
  .form-input{flex:1;background:transparent;border:none;outline:none;color:#e8ecf4;font-size:18px;min-width:60px}
  .form-buttons{display:flex;gap:6px;margin-top:6px}
  .form-btn{flex:1;padding:8px;background:#1a49c7;color:white;border:none;border-radius:8px;font-size:14px;cursor:pointer}
</style>
</head>
<body>

<header>
  <h1>SharpEdge Predictor</h1>
  <div class="tag">Find the edge. Bet smarter. Win long-term.</div>
</header>

<div class="wrap">

  <!-- TEAMS + FORM -->
  <div class="card">
    <div class="row">
      <div class="col">
        <label>Home</label>
        <select id="homeTeam"></select>
      </div>
      <div class="col">
        <label>Away</label>
        <select id="awayTeam"></select>
      </div>
    </div>

    <div class="row">
      <!-- HOME last-5 -->
      <div class="col">
        <label>Home last-5 (W/L)</label>
        <div class="form-box">
          <div id="homeFormChips" class="chips"></div>
          <input id="homeLast5" maxlength="5" placeholder="e.g. WWLLW" class="form-input" />
        </div>
        <div class="form-buttons">
          <button type="button" class="form-btn" onclick="addResult('homeLast5','W')">W</button>
          <button type="button" class="form-btn" onclick="addResult('homeLast5','L')">L</button>
        </div>
        <div id="homeFormViz" class="small"></div>
      </div>

      <!-- AWAY last-5 -->
      <div class="col">
        <label>Away last-5 (W/L)</label>
        <div class="form-box">
          <div id="awayFormChips" class="chips"></div>
          <input id="awayLast5" maxlength="5" placeholder="e.g. LWLWW" class="form-input" />
        </div>
        <div class="form-buttons">
          <button type="button" class="form-btn" onclick="addResult('awayLast5','W')">W</button>
          <button type="button" class="form-btn" onclick="addResult('awayLast5','L')">L</button>
        </div>
        <div id="awayFormViz" class="small"></div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Recent weight (last-5)</label>
        <input type="range" id="recentWeight" min="0" max="1" step="0.01" value="0.40" />
        <div class="small muted">Blends recent win% with a 50/50 baseline. Weight: <span id="rwVal">0.40</span></div>
      </div>
      <div class="col">
        <label>Bankroll</label>
        <input id="bankroll" type="number" value="2000" />
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="small muted">Home model</div>
        <div class="nums">Win%: <span id="homeWinPct">—</span> • Price est: <span id="homeModelPrice">—</span></div>
        <label class="small muted" style="margin-top:8px;">Market price (enter from book)</label>
        <input id="homeMarketPrice" type="number" value="1.85" step="0.01" />
        <label class="small muted" style="margin-top:8px;">Kelly fraction cap</label>
        <input type="range" id="kellyFrac" min="0.05" max="0.50" step="0.01" value="0.25" />
        <div class="small muted">Using fraction: <span id="kellyVal">0.25</span></div>
        <div style="margin-top:10px" class="nums">Edge: <span id="homeEdge">—</span> • Kelly stake: <span id="homeStake">—</span></div>
      </div>

      <div class="card">
        <div class="small muted">Away model</div>
        <div class="nums">Win%: <span id="awayWinPct">—</span> • Price est: <span id="awayModelPrice">—</span></div>
        <label class="small muted" style="margin-top:8px;">Market price (enter from book)</label>
        <input id="awayMarketPrice" type="number" value="2.05" step="0.01" />
        <div style="margin-top:10px" class="nums">Edge: <span id="awayEdge">—</span> • Kelly stake: <span id="awayStake">—</span></div>
      </div>
    </div>
  </div>

  <!-- LINE BETTING -->
  <div class="card">
    <h3 style="margin:0 0 8px">Line Betting (ATS)</h3>
    <div class="row">
      <div class="col">
        <label>Home line (e.g., -3.5)</label>
        <input id="homeLine" type="number" step="0.5" value="-2.5" />
      </div>
      <div class="col">
        <label>Line price (decimal)</label>
        <input id="linePrice" type="number" step="0.01" value="1.90" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label class="small muted">Model cover % (auto from win% heuristic; you can override)</label>
        <input id="coverPct" type="number" step="1" value="0" />
      </div>
      <div class="col">
        <label class="small muted">Heuristic aggressiveness (0.00–0.10)</label>
        <input type="range" id="coverHeuristic" min="0" max="0.10" step="0.005" value="0.04" />
        <div class="small muted">Current: <span id="coverHeuVal">0.04</span></div>
      </div>
    </div>
    <div class="nums" style="margin-top:8px">Line EV: <span id="lineEV">—</span> • Kelly stake: <span id="lineStake">—</span></div>
  </div>

  <!-- ACTIONS -->
  <div class="card">
    <div class="row">
      <div class="col">
        <button class="btn" id="clearBtn">Clear all</button>
      </div>
      <div class="col">
        <button class="btn" id="fetchOddsBtn" title="Optional: uses TheOddsAPI if you add a key in JS">Fetch market prices (optional)</button>
      </div>
    </div>
    <div class="footer">
      Enter W/L strings and market prices; the model calculates win%, fair prices, edge, and Kelly stakes.
      Line EV uses a simple mapping from win% → cover% (tunable). For live odds, add an API key in the JS hook.
    </div>
  </div>

</div>

<script>
/* ---------------------------- TEAMS + DEFAULT FORM --------------------------- */
const TEAMS = [
  "Adelaide 36ers","Brisbane Bullets","Cairns Taipans","Illawarra Hawks",
  "Melbourne United","NZ Breakers","Perth Wildcats","South East Melbourne Phoenix",
  "Sydney Kings","Tasmania JackJumpers"
];
const DEFAULT_LAST5 = {
  "Adelaide 36ers":"WLWLW",
  "Illawarra Hawks":"LWLWL",
  "Perth Wildcats":"WWWWW",
  "Sydney Kings":"LLWWW"
};

/* ------------------------------- DOM HANDLES -------------------------------- */
const el = id => document.getElementById(id);
const homeTeam = el('homeTeam'), awayTeam = el('awayTeam');
const homeLast5 = el('homeLast5'), awayLast5 = el('awayLast5');
const homeFormChips = el('homeFormChips'), awayFormChips = el('awayFormChips');
const homeFormViz = el('homeFormViz'), awayFormViz = el('awayFormViz');
const recentWeight = el('recentWeight'), rwVal = el('rwVal');
const bankroll = el('bankroll'), kellyFrac = el('kellyFrac'), kellyVal = el('kellyVal');

const homeWinPct = el('homeWinPct'), awayWinPct = el('awayWinPct');
const homeModelPrice = el('homeModelPrice'), awayModelPrice = el('awayModelPrice');
const homeMarketPrice = el('homeMarketPrice'), awayMarketPrice = el('awayMarketPrice');
const homeEdge = el('homeEdge'), awayEdge = el('awayEdge');
const homeStake = el('homeStake'), awayStake = el('awayStake');

const homeLine = el('homeLine'), linePrice = el('linePrice');
const coverPct = el('coverPct'), coverHeuristic = el('coverHeuristic'), coverHeuVal = el('coverHeuVal');
const lineEV = el('lineEV'), lineStake = el('lineStake');
const clearBtn = el('clearBtn'), fetchOddsBtn = el('fetchOddsBtn');

/* -------------------------- HELPERS & CALCULATIONS -------------------------- */
function clamp01(x){ return Math.max(0, Math.min(1, x)); }
function wlToWinPct(str){
  if(!str) return 0.5;
  const s = (str.toUpperCase().match(/[WL]/g)||[]).slice(0,5);
  if(s.length===0) return 0.5;
  const wins = s.filter(c=>c==='W').length;
  return wins / s.length;
}
function fairFromProb(p){ return p>0 ? (1/p) : Infinity; } // decimal odds
function edgeDecimal(p, price){ return p*(price-1) - (1-p); } // EV per $1
function kellyStake(bankroll, p, price, kcap){
  const b = price-1, q = 1-p;
  const frac = Math.max(0, (b*p - q)/b);
  const capped = Math.min(frac, kcap);
  return bankroll * capped;
}
function formatPct(x){ return (x*100).toFixed(1)+"%"; }
function formatMoney(x){ return !isFinite(x) ? "—" : "$"+(Math.round(x*100)/100).toLocaleString(); }

/* --------------------------- UI BUILD + SELECTIONS -------------------------- */
function buildSelect(sel){
  sel.innerHTML = '<option value="" disabled selected>Select a team…</option>' +
    TEAMS.map(t=>`<option value="${t}">${t}</option>`).join('');
  sel.addEventListener('change', ()=> {
    const t = sel.value;
    const input = (sel===homeTeam) ? homeLast5 : awayLast5;
    if(DEFAULT_LAST5[t] && !input.value) input.value = DEFAULT_LAST5[t];
    input.dispatchEvent(new Event('input')); // refresh chips + model
    recalc();
  }, {passive:true});
}
buildSelect(homeTeam); buildSelect(awayTeam);

/* ---------------------- W/L CHIP VISUALS (inside inputs) -------------------- */
function renderChips(str, target){
  const s = (str.toUpperCase().match(/[WL]/g)||[]).slice(0,5);
  target.innerHTML = s.map(c=>`<span class="chip ${c==='W'?'w':'l'}">${c}</span>`).join('');
}
function renderPills(str, target){
  const s = (str.toUpperCase().match(/[WL]/g)||[]).slice(0,5);
  if(s.length===0){ target.innerHTML=""; return; }
  target.innerHTML = s.map(c => `<span class="pill ${c==='W'?'ok':'bad'}">${c}</span>`).join('');
}
function updateFormVisual(id, chipId, pillId){
  const input = el(id);
  input.value = input.value.toUpperCase().replace(/[^WL]/g,'').slice(0,5);
  renderChips(input.value, el(chipId));
  renderPills(input.value, el(pillId));
}
function addResult(id, r){
  const input = el(id);
  if(input.value.length < 5){
    input.value += r;
    input.dispatchEvent(new Event('input'));
  }
}

/* -------------------------------- RECALC ----------------------------------- */
function recalc(){
  rwVal.textContent = (+recentWeight.value).toFixed(2);
  kellyVal.textContent = (+kellyFrac.value).toFixed(2);
  coverHeuVal.textContent = (+coverHeuristic.value).toFixed(3);

  // keep visuals in sync
  updateFormVisual('homeLast5','homeFormChips','homeFormViz');
  updateFormVisual('awayLast5','awayFormChips','awayFormViz');

  // Model win% (blend last-5 with 50/50 baseline)
  const w = +recentWeight.value;
  const pH_recent = wlToWinPct(homeLast5.value);
  const pA_recent = wlToWinPct(awayLast5.value);

  const pH = clamp01(w*pH_recent + (1-w)*0.5);
  const pA = clamp01(1 - pH); // simple two-team complement

  // Prices
  const fairH = fairFromProb(pH);
  const fairA = fairFromProb(pA);

  homeWinPct.textContent = formatPct(pH);
  awayWinPct.textContent = formatPct(pA);
  homeModelPrice.textContent = isFinite(fairH)? fairH.toFixed(2) : "—";
  awayModelPrice.textContent = isFinite(fairA)? fairA.toFixed(2) : "—";

  // Kelly vs market
  const br = +bankroll.value || 0;
  const kcap = +kellyFrac.value;

  const mH = +homeMarketPrice.value || 0;
  const mA = +awayMarketPrice.value || 0;

  const evH = edgeDecimal(pH, mH);
  const evA = edgeDecimal(pA, mA);

  homeEdge.textContent = (evH>=0?'+':'') + evH.toFixed(3);
  awayEdge.textContent = (evA>=0?'+':'') + evA.toFixed(3);

  homeStake.textContent = formatMoney(kellyStake(br, pH, mH, kcap));
  awayStake.textContent = formatMoney(kellyStake(br, pA, mA, kcap));

  // ----- Line EV (heuristic cover%) -----
  const line = +homeLine.value || 0;
  const alpha = +coverHeuristic.value; // sensitivity per point
  let pCover = clamp01(pH + (-line) * alpha); // favourite line (-) → boost cover%

  const manual = +coverPct.value;
  if(manual>0 && manual<100) pCover = clamp01(manual/100);

  const lp = +linePrice.value || 0;
  const evLine = edgeDecimal(pCover, lp);
  const stakeLine = kellyStake(br, pCover, lp, kcap);

  lineEV.textContent = (evLine>=0?'+':'') + evLine.toFixed(3);
  lineStake.textContent = formatMoney(stakeLine);
}

/* events */
['input','change'].forEach(evt=>{
  document.addEventListener(evt, e=>{
    if([
      'homeLast5','awayLast5','recentWeight','bankroll','kellyFrac',
      'homeMarketPrice','awayMarketPrice','homeLine','linePrice',
      'coverPct','coverHeuristic'
    ].includes(e.target.id)) recalc();
    if(e.target.id==='homeLast5') updateFormVisual('homeLast5','homeFormChips','homeFormViz');
    if(e.target.id==='awayLast5') updateFormVisual('awayLast5','awayFormChips','awayFormViz');
  }, {passive:true});
});
/* seed visuals on load */
updateFormVisual('homeLast5','homeFormChips','homeFormViz');
updateFormVisual('awayLast5','awayFormChips','awayFormViz');
recalc();

/* --------------------------------- ACTIONS --------------------------------- */
clearBtn.addEventListener('click', ()=>{
  homeTeam.selectedIndex = 0; awayTeam.selectedIndex = 0;
  homeLast5.value=''; awayLast5.value='';
  updateFormVisual('homeLast5','homeFormChips','homeFormViz');
  updateFormVisual('awayLast5','awayFormChips','awayFormViz');
  homeMarketPrice.value='1.85'; awayMarketPrice.value='2.05';
  homeLine.value='-2.5'; linePrice.value='1.90'; coverPct.value='0';
  recentWeight.value='0.40'; kellyFrac.value='0.25'; bankroll.value='2000';
  recalc();
});

/* ----------------------------- OPTIONAL: ODDS API --------------------------- */
/* If you want automatic prices, get a free key at theoddsapi.com and paste it below.
   This demo asks for AU Basketball odds and tries to find the selected teams. */
const ODDS_API_KEY = ""; // <- put your key here to enable
fetchOddsBtn.addEventListener('click', async ()=>{
  if(!ODDS_API_KEY){ alert("Add an API key in the JS (ODDS_API_KEY) to fetch prices."); return; }
  try{
    const sport = 'basketball_australia_nbl';
    const url = `https://api.theoddsapi.com/v4/sports/${sport}/odds/?regions=au&markets=h2h&oddsFormat=decimal&apiKey=${ODDS_API_KEY}`;
    const res = await fetch(url);
    const data = await res.json();
    const h = homeTeam.value, a = awayTeam.value;
    if(!h || !a){ alert("Select both teams first."); return; }
    let found = null;
    for(const game of data){
      const outcomes = game.bookmakers?.[0]?.markets?.[0]?.outcomes || [];
      const names = outcomes.map(o=>o.name);
      if(names.length===2 && names.some(n=>h.includes(n)) && names.some(n=>a.includes(n))){
        found = outcomes; break;
      }
    }
    if(found){
      const hObj = found.find(o=>h.includes(o.name));
      const aObj = found.find(o=>a.includes(o.name));
      if(hObj) homeMarketPrice.value = (+hObj.price).toFixed(2);
      if(aObj) awayMarketPrice.value = (+aObj.price).toFixed(2);
      recalc();
    }else{
      alert("Couldn’t match teams in the odds feed. Enter prices manually.");
    }
  }catch(err){
    console.error(err); alert("Odds fetch failed; enter prices manually.");
  }
});
</script>
</body>
</html>
