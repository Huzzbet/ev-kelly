<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EV & Kelly App + NBL Module</title>

<!-- ====== Minimal Dark Styles (Menu + Tabs + Table) ====== -->
<style>
:root{ --panel:#0e0e0e; --text:#eee; --border:#222; }
html,body{ margin:0; background:#0b0b0b; color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
h3{ margin:0; }

/* Corner menu button */
#menuBtn{
  position:fixed; top:12px; right:12px; z-index:1000;
  font-size:20px; padding:8px 10px; border-radius:8px;
  border:1px solid var(--border); background:#111; color:#eee;
}

/* Slide-in menu */
#sideMenu{
  position:fixed; top:0; right:-320px; width:320px; height:100%;
  background:var(--panel); color:var(--text); border-left:1px solid var(--border);
  transition:right 180ms ease; z-index:1001; padding:12px;
}
#sideMenu.open{ right:0; }
#sideMenu header{ display:flex; align-items:center; justify-content:space-between; }
#sideMenu h3{ font-size:18px; }
#closeMenu{ font-size:18px; padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:#171717; color:#eee; }
#sideMenu nav{ margin-top:12px; display:grid; gap:8px; }
#sideMenu .menu-item{
  width:100%; text-align:left; padding:10px 12px; border-radius:8px;
  background:#171717; border:1px solid #262626; color:#eee;
}

/* Page layout */
.container{ max-width:1000px; margin:72px auto 40px; padding:0 16px; }
.tab-panel{ margin-top:16px; }
.tab-header{ display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:8px; }
.nbl-controls label{ margin-right:8px; }
.card{ margin:12px 0; padding:12px; border:1px solid #262626; border-radius:10px; background:#111; }
.scroll-x{ overflow-x:auto; }

/* Table */
table{ width:100%; border-collapse:collapse; }
th,td{ padding:8px; border-bottom:1px solid #232323; white-space:nowrap; }
thead th{ position:sticky; top:0; background:#0f0f0f; }

/* EV badges */
.badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
.badge-neg{ background:#3a0b0b; }
.badge-mid{ background:#3a2f0b; }
.badge-pos{ background:#0b3a12; }

/* Basic app hero (optional) */
.hero{ margin-top:8px; padding:16px; border-radius:12px; border:1px solid #1d1d1d; background:#0f0f0f; }
</style>
</head>
<body>

<!-- ====== Corner Menu Button ====== -->
<button id="menuBtn" aria-label="Open menu">‚ò∞</button>

<!-- ====== Slide-in Menu ====== -->
<aside id="sideMenu" aria-hidden="true">
  <header>
    <h3>Menu</h3>
    <button id="closeMenu" aria-label="Close menu">‚úï</button>
  </header>
  <nav>
    <button class="menu-item" data-tab="nbl">üèÄ NBL ‚Äî Historical Results</button>
    <button class="menu-item" data-tab="guide">üìò EV & Kelly Guide</button>
    <button class="menu-item" data-tab="settings">‚öôÔ∏è Settings</button>
  </nav>
</aside>

<!-- ====== Main Container ====== -->
<div class="container">
  <div class="hero">
    <h2>EV & Kelly App</h2>
    <p>Fast stake sizing with edge, EV, fractional Kelly ‚Äî now with an NBL helper tab.</p>
  </div>

  <!-- NBL TAB -->
  <section id="tab-nbl" class="tab-panel" hidden>
    <div class="tab-header">
      <h3>NBL Historical Results</h3>
      <div class="nbl-controls">
        <label>
          Season:
          <select id="nblSeason">
            <option value="2024-25" selected>2024‚Äì25</option>
          </select>
        </label>
        <label>
          Market odds (home):
          <input id="nblMarketOdds" type="number" step="0.01" placeholder="e.g. 1.95">
        </label>
        <button id="nblRecalc">Recalc EV</button>
      </div>
    </div>

    <div id="nblSummary" class="card">Select a game row to see model probability, fair odds, EV and Kelly stake.</div>

    <div class="scroll-x">
      <table id="nblTable" aria-label="NBL games table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Round</th>
            <th>Home</th>
            <th>Away</th>
            <th>Score</th>
            <th>Winner</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody><!-- populated by JS --></tbody>
      </table>
    </div>

    <div id="nblTeamStats" class="card"><em>Team stats will appear here.</em></div>
  </section>

  <!-- Guide TAB -->
  <section id="tab-guide" class="tab-panel" hidden>
    <h3>EV & Kelly Guide</h3>
    <p>
      EV = p(win)√ó(odds‚àí1) ‚àí (1‚àíp(win)). Fair odds = 1 / p(win).<br>
      Full Kelly (decimal odds): <code>k = (b¬∑p ‚àí q) / b</code>, where <code>b = odds ‚àí 1</code>, <code>q = 1 ‚àí p</code>.
    </p>
  </section>

  <!-- Settings TAB -->
  <section id="tab-settings" class="tab-panel" hidden>
    <h3>Settings</h3>
    <label><input id="settingDecimalOdds" type="checkbox" checked> Use decimal odds</label>
  </section>
</div>

<!-- ====== NBL Module Loader (runs after DOM ready) ====== -->
<script>
(function () {
  document.addEventListener('DOMContentLoaded', function () {
    /* ---------- MENU WIRING ---------- */
    const menuBtn = document.getElementById('menuBtn');
    const sideMenu = document.getElementById('sideMenu');
    const closeMenu = document.getElementById('closeMenu');
    const panels = document.querySelectorAll('.tab-panel');

    function openTab(name){
      panels.forEach(p => p.hidden = true);
      const el = document.getElementById('tab-' + name);
      if (el) el.hidden = false;
      if (name === 'nbl') initNBL();
    }

    if (menuBtn && sideMenu && closeMenu) {
      menuBtn.addEventListener('click', () => sideMenu.classList.add('open'));
      closeMenu.addEventListener('click', () => sideMenu.classList.remove('open'));
      document.querySelectorAll('#sideMenu .menu-item').forEach(btn => {
        btn.addEventListener('click', () => {
          openTab(btn.dataset.tab);
          sideMenu.classList.remove('open');
        });
      });
    }

    /* ---------- NBL STATE + HELPERS ---------- */
    const NBL_STATE = {
      games: [],
      teams: {},
      season: '2024-25',
      dataUrl: 'data/nbl_2024.json'   // ‚Üê update to your real JSON path
    };

    const q = sel => document.querySelector(sel);

    function winnerRow(g){ return g.home_score > g.away_score ? g.home : (g.away_score > g.home_score ? g.away : 'Draw'); }
    function totalPoints(g){ return (g.home_score||0) + (g.away_score||0); }
    function fairOdds(p){ return p>0 ? 1/p : Infinity; }
    function evPerDollar(pWin, odds){ const b=odds-1, q=1-pWin; return pWin*b - q; }
    function kellyFull(pWin, odds){ const b=odds-1, q=1-pWin; return Math.max(0,(b*pWin - q)/b); }
    function badge(ev){ if(ev<0) return '<span class="badge badge-neg">‚àíEV</span>'; if(ev<0.02) return '<span class="badge badge-mid">~EV</span>'; return '<span class="badge badge-pos">+EV</span>'; }

    function computeTeams(games){
      const tmap = {};
      const touch = t => (tmap[t] ??= { team:t, gp:0,w:0,l:0,ppg:0,oppg:0,home:{gp:0,w:0}, last5:[] });
      games.forEach(g=>{
        const h=touch(g.home), a=touch(g.away);
        h.gp++; a.gp++; h.ppg+=g.home_score; h.oppg+=g.away_score; a.ppg+=g.away_score; a.oppg+=g.home_score;
        h.home.gp++;
        const w=winnerRow(g);
        if(w===g.home){h.w++; a.l++; h.home.w++;} else if(w===g.away){a.w++; h.l++;}
        h.last5.push(w===g.home?1:0); a.last5.push(w===g.away?1:0);
        if(h.last5.length>5) h.last5.shift(); if(a.last5.length>5) a.last5.shift();
      });
      Object.values(tmap).forEach(t=>{
        t.winPct=t.gp? t.w/t.gp:0;
        t.ppg=t.gp? t.ppg/t.gp:0; t.oppg=t.gp? t.oppg/t.gp:0;
        t.home.winPct=t.home.gp? t.home.w/t.home.gp:0;
        t.last5Pct=t.last5.length? t.last5.reduce((a,b)=>a+b,0)/t.last5.length:0;
      });
      return tmap;
    }

    // v1 matchup: win% + last5 + home edge
    function modelHomeWinProb(home, away){
      const h=NBL_STATE.teams[home], a=NBL_STATE.teams[away];
      if(!h||!a) return 0.5;
      const base=(h.winPct - a.winPct)*0.4 + (h.last5Pct - a.last5Pct)*0.2 + (h.home.winPct - a.winPct)*0.2;
      let p=0.5 + base + 0.04; // +4% home
      return Math.min(0.85, Math.max(0.15, p));
    }

    async function initNBL(){
      if (!NBL_STATE.games.length){
        try{
          const res = await fetch(NBL_STATE.dataUrl, { cache:'no-store' });
          if(!res.ok) throw new Error('fetch failed');
          NBL_STATE.games = await res.json();
        }catch(e){
          console.warn('Using built-in sample:', e);
          NBL_STATE.games = [
            {"date":"2025-01-10","season":"2024-25","round":12,"home":"Melbourne United","away":"Sydney Kings","home_score":92,"away_score":86,"venue":"John Cain Arena"},
            {"date":"2025-01-12","season":"2024-25","round":12,"home":"Perth Wildcats","away":"New Zealand Breakers","home_score":101,"away_score":95,"venue":"RAC Arena"},
            {"date":"2025-01-14","season":"2024-25","round":13,"home":"Illawarra Hawks","away":"Cairns Taipans","home_score":78,"away_score":83,"venue":"WIN Entertainment Centre"}
          ];
        }
        NBL_STATE.teams = computeTeams(NBL_STATE.games);
      }
      renderNBL();
    }

    function renderNBL(){
      const tb = q('#nblTable tbody'); if(!tb) return;
      tb.innerHTML = '';
      NBL_STATE.games
        .filter(g=>g.season===NBL_STATE.season)
        .sort((a,b)=>a.date.localeCompare(b.date))
        .forEach(g=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${g.date}</td>
            <td>${g.round ?? ''}</td>
            <td>${g.home}</td>
            <td>${g.away}</td>
            <td>${g.home_score}‚Äì${g.away_score}</td>
            <td>${winnerRow(g)}</td>
            <td>${totalPoints(g)}</td>`;
          tr.addEventListener('click', ()=> showMatchupCard(g));
          tb.appendChild(tr);
        });

      const teamsSorted = Object.values(NBL_STATE.teams).sort((a,b)=>b.winPct-a.winPct);
      const top = teamsSorted.slice(0,8).map(t=>`<li>${t.team}: ${(t.winPct*100).toFixed(1)}% W ‚Ä¢ PPG ${t.ppg.toFixed(1)} ‚Ä¢ OPPG ${t.oppg.toFixed(1)}</li>`).join('');
      const sum = q('#nblSummary');
      if (sum) sum.innerHTML = `<strong>Season ${NBL_STATE.season}</strong><ul>${top}</ul>`;

      const recalc = q('#nblRecalc');
      if (recalc) recalc.onclick = () => { if (window.__lastMatch) showMatchupCard(window.__lastMatch); };
    }

    function showMatchupCard(g){
      window.__lastMatch = g;
      const pHome = modelHomeWinProb(g.home, g.away);
      const fair = fairOdds(pHome);
      const market = parseFloat(q('#nblMarketOdds')?.value || '0');
      const ev = market>1 ? evPerDollar(pHome, market) : 0;
      const kelly = market>1 ? kellyFull(pHome, market) : 0;

      const html = `
        <div class="card">
          <div><strong>${g.home}</strong> vs <strong>${g.away}</strong> ‚Äî ${g.date} (R${g.round ?? ''})</div>
          <div>Model home win prob: <strong>${(pHome*100).toFixed(1)}%</strong> ‚Ä¢ Fair odds: <strong>${fair.toFixed(2)}</strong></div>
          <div>Market (home): <strong>${isFinite(market)&&market>1 ? market.toFixed(2) : '‚Äî'}</strong>
            ‚Ä¢ EV/$: <strong>${ev.toFixed(3)}</strong> ${badge(ev)}
            ‚Ä¢ Full-Kelly: <strong>${(kelly*100).toFixed(2)}%</strong></div>
          <small>Note: v1 model = season/last-5 blend + 4% home edge; clamp 15‚Äì85%.</small>
        </div>`;
      const sum = q('#nblSummary');
      if (sum) sum.innerHTML = html;
    }

    // For quick testing, auto-open NBL tab once:
    // document.querySelector('[data-tab="nbl"]')?.click();
  });
})();
</script>

</body>
</html>
