<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BetIQ ‚Äî NBL History Engine (Last 5)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ---------- Base ---------- */
    :root {
      --bg: #0f1220;
      --panel: #121732;
      --muted: #94a3b8;
      --text: #f1f5f9;
      --line: #232a44;
      --brand: #cbd5e1;
      --chip: #0b1020;
      --chip-line: #2a335a;
      --win-bg: #16a34a22;
      --win-br: #16a34a55;
      --win-tx: #86efac;
      --loss-bg: #dc262622;
      --loss-br: #dc262655;
      --loss-tx: #fecaca;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    a { color: var(--brand); text-decoration: none; }
    header { position: sticky; top:0; z-index:10; display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background:#11162a; border-bottom:1px solid var(--line); }
    .brand { font-weight:700; letter-spacing:0.4px; }
    nav a { margin:0 8px; color:#cbd5e1; }
    nav a:hover { color:#fff; }
    main { max-width:1100px; margin:24px auto; padding:0 16px; }
    .card { background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:16px; margin-bottom:16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .muted { color:var(--muted); font-size:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .pill { background:var(--chip); border:1px solid var(--chip-line); padding:8px 10px; border-radius:999px; }
    select, button, input[type="text"] { background:#0d1124; color:#e2e8f0; border:1px solid var(--chip-line); border-radius:8px; padding:10px 12px; }
    button { cursor:pointer; }
    .grid { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 960px) { .grid { grid-template-columns: 1fr 1fr; } }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border-bottom:1px solid var(--line); padding:10px 8px; text-align:left; }
    .tag { display:inline-block; padding:2px 8px; border-radius:16px; font-size:12px; margin-right:6px; }
    .tag-win { background:var(--win-bg); border:1px solid var(--win-br); color:var(--win-tx); }
    .tag-loss { background:var(--loss-bg); border:1px solid var(--loss-br); color:var(--loss-tx); }
    .copybox { width:100%; min-height:140px; }
    .teamHead { display:flex; align-items:center; gap:12px; }
    .logo { width:36px; height:36px; border-radius:6px; background:#0b1020; border:1px solid var(--chip-line); object-fit:contain; }
    .logo.big { width:44px; height:44px; }
    .chips { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  </style>
</head>
<body>
  <header>
    <div class="brand">üèÄ BetIQ ‚Äî History Engine</div>
    <nav>
      <a href="index.html">Home</a>
      <a href="analysis.html">Analysis</a>
      <a href="history.html"><strong>History</strong></a>
    </nav>
  </header>

  <main>
    <!-- Controls -->
    <div class="card">
      <h2 style="margin:0 0 6px;">Last Five Games Builder</h2>
      <div class="muted">Reads <span class="mono">/data/nbl_games_2025.json</span>, computes per-team last-5, caches to <span class="mono">localStorage.lastFiveStats</span>, and renders below.</div>
      <div class="row" style="margin-top:12px;">
        <label class="pill">JSON path:&nbsp;<input id="jsonPath" type="text" value="data/nbl_games_2025.json" size="34"/></label>
        <button id="reloadBtn">Reload & Compute</button>
        <button id="copyBtn" title="Copy computed summaries as JSON">Copy JSON</button>
      </div>
      <div class="row">
        <label>Filter team:&nbsp;
          <select id="teamFilter">
            <option value="">All teams</option>
          </select>
        </label>
        <span class="muted">Tip: keep dates ISO (YYYY-MM-DD). Most-recent 5 by date are used.</span>
      </div>
    </div>

    <!-- Output -->
    <div id="summary" class="grid"></div>

    <!-- Debug / export -->
    <div class="card">
      <h3 style="margin-top:0;">Export (debug)</h3>
      <textarea id="exportBox" class="copybox mono" readonly></textarea>
    </div>
  </main>

  <script>
    /* =======================
       Team Logo Mapping
       ======================= */
    const TEAM_LOGO_MAP = {
      "Adelaide 36ers": "assets/logos/adelaide-36ers.png",
      "Brisbane Bullets": "assets/logos/brisbane-bullets.png",
      "Cairns Taipans": "assets/logos/cairns-taipans.png",
      "Illawarra Hawks": "assets/logos/illawarra-hawks.png",
      "Melbourne United": "assets/logos/melbourne-united.png",
      "NZ Breakers": "assets/logos/nz-breakers.png",
      "Perth Wildcats": "assets/logos/perth-wildcats.png",
      "South East Melbourne": "assets/logos/sem-phoenix.png",
      "Sydney Kings": "assets/logos/sydney-kings.png",
      "Tasmania JackJumpers": "assets/logos/tasmania-jackjumpers.png"
    };
    function getLogoSrc(team){
      return TEAM_LOGO_MAP[team] || "assets/logos/default.png"; // fallback image if missing
    }

    /* =======================
       Utilities
       ======================= */
    const byDateDesc = (a,b)=> (a.date < b.date ? 1 : a.date > b.date ? -1 : 0);

    function el(tag, attrs={}, children=[]){
      const e = document.createElement(tag);
      for (const k in attrs){
        if (k === "class") e.className = attrs[k];
        else if (k === "html") e.innerHTML = attrs[k];
        else e.setAttribute(k, attrs[k]);
      }
      (Array.isArray(children) ? children : [children]).forEach(c=>{
        if (typeof c === "string") e.appendChild(document.createTextNode(c));
        else if (c) e.appendChild(c);
      });
      return e;
    }

    function teamNamesFrom(games){
      const set = new Set();
      games.forEach(g => { set.add(g.home); set.add(g.away); });
      return Array.from(set).sort();
    }

    function resultForTeam(game, team){
      const isHome = game.home === team;
      const myScore = isHome ? game.homeScore : game.awayScore;
      const oppTeam = isHome ? game.away : game.home;
      const oppScore = isHome ? game.awayScore : game.homeScore;
      const res = myScore > oppScore ? "W" : "L";
      return {
        date: String(game.date),
        round: game.round ?? "",
        opponent: oppTeam,
        location: isHome ? "H" : "A",
        myScore, oppScore, res
      };
    }

    function lastFiveForTeam(allGames, team){
      const played = allGames
        .filter(g => g.home === team || g.away === team)
        .sort(byDateDesc)
        .map(g => resultForTeam(g, team));
      const last5 = played.slice(0,5);
      const wins = last5.filter(x=>x.res==="W").length;
      const losses = last5.length - wins;
      const wlString = last5.map(x=>x.res).join(" ");
      const winPct = last5.length ? Number(((wins/last5.length)*100).toFixed(1)) : 0;
      return { team, games:last5, wins, losses, winPct, wlString };
    }

    function computeAllLastFive(allGames){
      const teams = teamNamesFrom(allGames);
      const map = {};
      teams.forEach(t => map[t] = lastFiveForTeam(allGames, t));
      return map;
    }

    function wlBadge(ch){ return el("span",{class:"tag " + (ch==="W"?"tag-win":"tag-loss")}, ch); }

    function renderTeamCard(s){
      const head = el("div", {class:"teamHead"}, [
        el("img", {class:"logo big", src:getLogoSrc(s.team), alt:s.team + " logo"}),
        el("div", {}, [
          el("h3", {style:"margin:0 0 2px;"}, s.team),
          el("div", {class:"chips"}, [
            el("span", {class:"pill"}, `Win%: ${s.winPct}%`),
            el("span", {class:"pill"}, `Record: ${s.wins}-${s.losses}`)
          ])
        ])
      ]);

      const wlRow = el("div", {class:"row"}, s.wlString.split(" ").map(wlBadge));

      const tbl = el("table");
      tbl.appendChild(el("thead", {}, el("tr",{},[
        el("th",{}, "Date"),
        el("th",{}, "R"),
        el("th",{}, "Opponent"),
        el("th",{}, "Loc"),
        el("th",{}, "Score"),
        el("th",{}, "Res")
      ])));
      const tb = el("tbody");
      s.games.forEach(g=>{
        tb.appendChild(el("tr",{},[
          el("td",{}, g.date),
          el("td",{}, String(g.round)),
          el("td",{}, [
            el("img", {class:"logo", src:getLogoSrc(g.opponent), alt:g.opponent + " logo", title:g.opponent}),
            " ",
            g.opponent
          ]),
          el("td",{}, g.location),
          el("td",{}, `${g.myScore}‚Äì${g.oppScore}`),
          el("td",{}, g.res),
        ]));
      });
      tbl.appendChild(tb);

      return el("div", {class:"card"}, [head, wlRow, tbl]);
    }

    /* =======================
       Page Logic
       ======================= */
    const summaryDiv = document.getElementById("summary");
    const exportBox = document.getElementById("exportBox");
    const teamFilter = document.getElementById("teamFilter");
    const reloadBtn = document.getElementById("reloadBtn");
    const copyBtn = document.getElementById("copyBtn");
    const jsonPathInput = document.getElementById("jsonPath");

    let rawGames = [];
    let summaries = {};

    async function loadAndCompute(){
      const path = jsonPathInput.value.trim();
      const res = await fetch(path + (path.includes("?") ? "&" : "?") + "t=" + Date.now());
      if (!res.ok){ throw new Error("Failed to load JSON at " + path); }
      const data = await res.json();

      // Validate & normalise
      rawGames = data
        .filter(g => g && g.date && g.home && g.away && Number.isFinite(g.homeScore) && Number.isFinite(g.awayScore))
        .map(g => ({...g, date: String(g.date)}))
        .sort(byDateDesc);

      summaries = computeAllLastFive(rawGames);

      // Cache for other pages
      localStorage.setItem("lastFiveStats", JSON.stringify({
        updatedAt: new Date().toISOString(),
        source: path,
        summaries
      }));

      render();
      exportBox.value = JSON.stringify(summaries, null, 2);
      populateTeamFilter();
    }

    function populateTeamFilter(){
      const teams = Object.keys(summaries).sort();
      const current = teamFilter.value;
      teamFilter.innerHTML = '<option value="">All teams</option>';
      teams.forEach(t=>{
        const opt = document.createElement("option");
        opt.value = t; opt.textContent = t;
        teamFilter.appendChild(opt);
      });
      if (teams.includes(current)) teamFilter.value = current;
    }

    function render(){
      summaryDiv.innerHTML = "";
      const teams = Object.keys(summaries).sort();
      const filt = teamFilter.value;
      teams
        .filter(t => !filt || t === filt)
        .forEach(t => summaryDiv.appendChild(renderTeamCard(summaries[t])));
    }

    reloadBtn.addEventListener("click", () => {
      loadAndCompute().catch(err => exportBox.value = "Error: " + err.message);
    });
    copyBtn.addEventListener("click", ()=>{
      exportBox.select();
      document.execCommand("copy");
    });
    teamFilter.addEventListener("change", render);

    // Auto-run on load
    loadAndCompute().catch(err=>{
      exportBox.value = "Error: " + err.message + "\n\nCheck your JSON path and ensure the file exists in the repo.";
    });

    /* =======================
       Helper for other pages
       ======================= */
    // After History runs, any page can call:
    //   const stats = getLastFiveForTeam("Sydney Kings");
    // to grab the cached summary.
    window.getLastFiveForTeam = function(team){
      try{
        const store = JSON.parse(localStorage.getItem("lastFiveStats") || "{}");
        return store.summaries?.[team] || null;
      }catch(e){ return null; }
    };
  </script>
</body>
</html>
